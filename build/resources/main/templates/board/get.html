<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout2}">
<head>
  <meta charset="UTF-8">
  <!-- CSRF 토큰을 위한 meta 태그 추가 -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>글 보기</title>
  <link rel="stylesheet" th:href="@{/css/board.css}">
  <!-- JS 파일 연결 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/boardGet.js"></script>
</head>
<body>
<div layout:fragment="content">
  <div class="view-container">
    <div class="board-header">
      <div class="title-section">
        <span class="title" th:text="${boardDTO.boardTitle}"></span>
      </div>
      <div class="info-section">
        <div class="left-info">
          <span class="writer" th:text="${boardDTO.boardWriter}"></span>
          <span class="separator">|</span>
          <span class="date" th:text="${#temporals.format(boardDTO.regiDate, 'yyyy.MM.dd HH:mm')}"></span>
        </div>
        <div class="right-info">
                <span class="views">
                    <i class="fas fa-eye"></i>
                    <span th:text="${boardDTO.views}"></span>
                </span>
          <div class="dropdown">
            <a href="#" class="zip-download-btn" th:if="${boardDTO.hasZipFile}">
              <i class="fas fa-ellipsis-v"></i>
            </a>
            <div class="dropdown-content">
              <div th:each="file : ${boardDTO.BoardFileList}"
                   th:if="${file.isZip == 'Y'}"
                   class="dropdown-item">
                <a th:href="@{/board/download/{fileId}(fileId=${file.fileId})}"
                   class="file-link">압축파일 다운로드</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 이미지 갤러리 섹션 -->
    <div class="image-gallery-container" th:if="${boardDTO.BoardFileList != null and not #lists.isEmpty(boardDTO.BoardFileList)}">
      <!-- 썸네일 목록 -->
      <div class="thumbnail-wrapper">
        <div class="thumbnail-list">
          <div th:each="file : ${boardDTO.BoardFileList}"
               th:if="${#strings.toLowerCase(file.orignalName).endsWith('.jpg') or
                   #strings.toLowerCase(file.orignalName).endsWith('.jpeg') or
                   #strings.toLowerCase(file.orignalName).endsWith('.png') or
                   #strings.toLowerCase(file.orignalName).endsWith('.PNG') or
                   #strings.toLowerCase(file.orignalName).endsWith('.gif')}"
               class="thumbnail-item">
            <img th:src="@{'/images/' + ${file.modifiedName}}"
                 th:data-filename="${file.orignalName}"
                 alt="썸네일 이미지"
                 class="thumbnail"
                 onclick="updatePreview(this)">
          </div>
        </div>
      </div>

      <!-- 큰 이미지 프리뷰 -->
      <div class="preview-container">
        <div class="preview-content">
          <img id="preview-image"
               th:if="${boardDTO.BoardFileList != null and not #lists.isEmpty(boardDTO.BoardFileList)}"
               th:src="@{'/images/' + ${boardDTO.BoardFileList[0].modifiedName}}"
               alt="이미지 프리뷰">
          <div class="preview-filename" th:text="${boardDTO.BoardFileList[0].orignalName}"></div>
        </div>
      </div>
    </div>
    <!-- 게시글 내용 부분은 유지 -->
    <div class="board-content">
      <div th:utext="${boardDTO.boardContents}" class="content-area"></div>
    </div>

    <div class="button-group">
      <a href="javascript:history.back()" class="btn btn-secondary">뒤로가기</a>
      <button id="toggleComments" class="btn btn-primary">댓글보기</button>
    </div>

    <div id="comments-section" class="comments-section" style="display: none;">
      <div class="comment-form">
        <h3>댓글 작성</h3>
        <textarea id="contents" name="contents" placeholder="댓글을 입력하세요"></textarea>
        <button onclick="submitComment()" class="btn btn-primary">댓글 등록</button>
      </div>

      <!-- 댓글 목록 -->
      <div class="comments-list">
        <h3>댓글 목록</h3>
        <div th:each="comment : ${comments}" class="comment-item">
          <div class="comment-header">
            <span class="comment-writer" th:text="${comment.writer}"></span>
            <span class="comment-date" th:text="${#temporals.format(comment.regiDate, 'yyyy.MM.dd HH:mm')}"></span>
          </div>
          <div class="comment-content" th:text="${comment.contents}"></div>
          <!-- <div class="comment-actions" th:if="${comment.writer == #authentication.name}">-->
          <div class="comment-actions">
            <button th:onclick="'editComment(${comment.commentsId})'" class="btn btn-sm btn-primary">수정</button>
            <button th:onclick="'deleteComment(${comment.commentsId})'" class="btn btn-sm btn-danger">삭제</button>
          </div>
        </div>
      </div>
    </div>

    <div class="board-footer">
      <!--  <a th:if="${boardDTO.boardWriter == #authentication.name}"
           th:href="@{/board/modify/{boardId}(boardId=${boardDTO.boardId})}"
           class="btn btn-primary">수</a>

        <button th:if="${boardDTO.boardWriter == #authentication.name}"
                onclick="deleteBoard([[${boardDTO.boardId}]])"
                class="btn btn-danger">삭제</button>-->
      <a th:href="@{/board/modify/{boardId}(boardId=${boardDTO.boardId})}"
         class="btn btn-primary">수정</a>

      <button onclick="deleteBoard([[${boardDTO.boardId}]])"
              class="btn btn-danger">삭제</button>
    </div>

    <!-- 첨부파일이 있는 경우 표시 -->
    <div class="file-container" th:if="${boardDTO.BoardFileList != null and not #lists.isEmpty(boardDTO.BoardFileList)}">
      <h3>첨부파일</h3>

      <!-- 개별 파일 다운로드 섹션 -->
      <div class="individual-download">
        <h4>개 파일 다운로드</h4>
        <div class="file-list">
          <div th:each="file : ${boardDTO.BoardFileList}"
               th:if="${file.isZip == 'N'}"
               class="file-item">
            <a th:href="@{/board/download/{fileId}(fileId=${file.fileId})}"
               class="file-link">
              <i class="fas fa-file"></i>
              <span th:text="${file.orignalName}"></span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript 코드 제거하고 스크립트 태그만 남김 -->
    <script th:inline="javascript">
        // boardId와 함께 필요한 데이터를 전역 변수로 선언
        const boardId = [[${boardDTO.boardId}]];
        const boardFiles = [[${boardDTO.BoardFileList}]];
    </script>
  </div>
</div>
</body>

</html>