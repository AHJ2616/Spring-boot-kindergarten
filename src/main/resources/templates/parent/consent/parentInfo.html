<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>í•™ë¶€ëª¨ ì •ë³´ ì…ë ¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .form-container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .form-title {
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d6efd;
    }
    .required-mark {
      color: red;
      margin-left: 3px;
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .optional-text {
      color: #6c757d;
      font-size: 0.875rem;
      margin-left: 5px;
    }

    .registration-guide {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #0d6efd;
    }
    .registration-guide h3 {
      color: #0d6efd;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    .registration-guide p {
      color: #6c757d;
      margin-bottom: 10px;
      line-height: 1.6;
    }
    .registration-guide ul {
      padding-left: 20px;
      margin-bottom: 0;
    }
    .registration-guide li {
      color: #495057;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .required {
      color: #dc3545;
      margin-left: 3px;
    }
    .guide-section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .guide-subtitle {
      color: #0d6efd;
      margin-bottom: 10px;
    }
    .guide-content ul {
      padding-left: 20px;
    }
    .guide-content li {
      margin-bottom: 8px;
    }
    .input-group .form-control {
      text-align: center;
    }
    .input-group .input-group-text {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
<div class="form-container">
  <h2 class="form-title">í•™ë¶€ëª¨ ì •ë³´ ì…ë ¥</h2>
  <!-- ê°€ì´ë“œ ë²„íŠ¼ ì¶”ê°€ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#guideModal">
      <i class="bi bi-question-circle"></i> ğŸ“Œì™œ ì´ëŸ° ì •ë³´ë¥¼ ì…ë ¥í•´ì•¼ í•˜ë‚˜ìš”?
    </button>
  </div>

  <!-- ê°€ì´ë“œ ëª¨ë‹¬ -->
  <div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="guideModalLabel">ğŸ“‹ í•™ë¶€ëª¨ ë“±ë¡ ê°€ì´ë“œ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="guide-content">
            <div class="guide-section">
              <h6 class="guide-subtitle">ğŸ’¡ ì‹œìŠ¤í…œ ì„¤ëª… ì•ˆë‚´</h6>
              <p>ERP ì‹œìŠ¤í…œì—ì„œ ì§ì›(ì›ì¥, êµì‚¬)ì´(ê°€) í•™ë¶€ëª¨ ë“±ë¡í•˜ê¸°ë¥¼ ì…ë ¥í•˜ëŠ” ê³¼ì •ì´ ìˆìŠµë‹ˆë‹¤. </p>
              <p>ì•ì„œ ì‘ì„±í•œ ì•½ê´€, ë™ì˜ì„œì™€ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  ì´ë©”ì¼ê³¼ ê° ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë“±ë¡ í›„ </p>
              <p>ì´ë©”ì¼ê³¼ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í†µë³´ í›„ í•´ë‹¹ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€ë¡œ ì•ˆë‚´í•´ ë“œë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="guide-section">
              <h6 class="guide-subtitle">ğŸ” ì…ë ¥ ì •ë³´ ì•ˆë‚´</h6>
              <p>ì•„ë˜ ì–‘ì‹ì„ í†µí•´ í•™ë¶€ëª¨ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>
              <p>ìœ ì¹˜ì›ê³¼ì˜ ì›í™œí•œ ì†Œí†µ ë° ì‹œìŠ¤í…œ ê´€ë¦¬ë¥¼ ìœ„í•´ í•„ìš”í•œ ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            </div>

            <div class="guide-section">
              <h6 class="guide-subtitle">âœ… í•„ìˆ˜ ì…ë ¥ ì‚¬í•­</h6>
              <ul>
                <li>ì´ë©”ì¼ (ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©)</li>
                <li>ì„±í•¨</li>
                <li>íœ´ëŒ€í° ë²ˆí˜¸</li>
                <li>ì£¼ì†Œ</li>
                <li>ìƒì„¸ì£¼ì†Œ</li>
              </ul>
            </div>

            <div class="guide-section">
              <h6 class="guide-subtitle">ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸</h6>
              <ul>
                <li>ì…ë ¥ëœ ì •ë³´ëŠ” ìœ ì¹˜ì› ì‹œìŠ¤í…œì—ì„œë§Œ ì‚¬ìš©ë˜ë©°, ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.</li>
                <li>ì…ë ¥ëœ ì •ë³´ëŠ” ì¶”í›„ í•™ë¶€ëª¨ ì „ìš© ì‹œìŠ¤í…œì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë©°, ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ë“±ë¡ í›„, í•™ë¶€ëª¨ ì „ìš© ì‹œìŠ¤í…œì—ì„œ ì°¾ê¸° ì‰½ë„ë¡ ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
                <li> ê°œì¸ì •ë³´ ë³´í˜¸ ë° ì˜ˆë°© êµìœ¡ì„ ì›ë‚´ ì§ì›ë“¤ì—ê²Œ ì£¼ê¸°ì ìœ¼ë¡œ êµìœ¡ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <form th:action="@{/consent/register-parent}" method="post" id="parentInfoForm">
    <!-- ë¡œê·¸ì¸ ì •ë³´ ì„¹ì…˜ -->
    <div class="form-section">
      <h4 class="mb-4">ë¡œê·¸ì¸ ì •ë³´</h4>
      <div class="form-group">
        <label for="parentEmail">ì´ë©”ì¼<span class="required-mark">*</span></label>
        <div class="input-group">
          <input type="email" class="form-control" id="parentEmail" name="parentEmail" required>
          <button type="button" class="btn btn-outline-primary" onclick="checkEmailDuplicate()">ì¤‘ë³µí™•ì¸</button>
        </div>
        <div class="form-text" id="emailHelp">ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
      </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ì„¹ì…˜ -->
    <div class="form-section">
      <h4 class="mb-4">í•™ë¶€ëª¨ ê°œì¸ì •ë³´</h4>
      <div class="form-group">
        <label for="parentName">ì„±í•¨<span class="required-mark">*</span></label>
        <input type="text" class="form-control" id="parentName" name="parentName" required>
      </div>

      <div class="form-group">
        <label>íœ´ëŒ€í° ë²ˆí˜¸<span class="required-mark">*</span></label>
        <div class="input-group">
          <select class="form-select" id="phone1" style="max-width: 100px;">
            <option value="010">010</option>
            <option value="011">011</option>
            <option value="016">016</option>
            <option value="017">017</option>
            <option value="018">018</option>
            <option value="019">019</option>
          </select>
          <span class="input-group-text">-</span>
          <input type="text" class="form-control" id="phone2" maxlength="4">
          <span class="input-group-text">-</span>
          <input type="text" class="form-control" id="phone3" maxlength="4">
          <input type="hidden" name="parentPhone" id="parentPhone">
        </div>
      </div>

      <div class="form-group">
        <label>ë¹„ìƒì—°ë½ì²˜<span class="optional-text">(ì„ íƒì‚¬í•­)</span></label>
        <div class="input-group">
          <select class="form-select" id="emergency1" style="max-width: 100px;">
            <option value="010">010</option>
            <option value="011">011</option>
            <option value="016">016</option>
            <option value="017">017</option>
            <option value="018">018</option>
            <option value="019">019</option>
          </select>
          <span class="input-group-text">-</span>
          <input type="text" class="form-control" id="emergency2" maxlength="4">
          <span class="input-group-text">-</span>
          <input type="text" class="form-control" id="emergency3" maxlength="4">
          <input type="hidden" name="childrenEmergencyPhone" id="childrenEmergencyPhone">
        </div>
        <div class="form-text">ë¹„ìƒì‹œ ì—°ë½ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
      </div>

      <div class="form-group">
        <label for="parentAddress">ì£¼ì†Œ<span class="required-mark">*</span></label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
          <button type="button" class="btn btn-outline-primary" onclick="searchAddress()">ì£¼ì†Œ ê²€ìƒ‰</button>
        </div>
        <input type="text" class="form-control mb-2" id="parentAddress" name="parentAddress" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly required>
        <input type="text" class="form-control" id="detailAddress" name="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ">
      </div>
    </div>

    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="d-flex justify-content-between mt-4">
      <button type="button" class="btn btn-secondary" onclick="history.back()">ì´ì „</button>
      <button type="submit" class="btn btn-primary" onclick="return validateAndSubmit()">ê°€ì… ì™„ë£Œ</button>
    </div>

  </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Daum ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
  function checkEmailDuplicate() {
    const email = document.getElementById('parentEmail').value;
    const emailHelp = document.getElementById('emailHelp');
    const emailInput = document.getElementById('parentEmail');

    // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
      return;
    }

    // AJAX ìš”ì²­
    fetch(`/consent/check-email?email=${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
              if (data.isDuplicate) {
                emailHelp.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                emailHelp.className = 'form-text text-danger';
                emailInput.classList.add('is-invalid');
              } else {
                emailHelp.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                emailHelp.className = 'form-text text-success';
                emailInput.classList.add('is-valid');
                emailInput.classList.remove('is-invalid');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              emailHelp.textContent = 'ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
              emailHelp.className = 'form-text text-danger';
            });
  }

  // ì£¼ì†Œ ê²€ìƒ‰
  function searchAddress() {
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById('postcode').value = data.zonecode;
        document.getElementById('parentAddress').value = data.address;
        document.getElementById('detailAddress').focus();
      }
    }).open();
  }

  // í¼ ì œì¶œ ì²˜ë¦¬
  document.getElementById('parentInfoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const email = document.getElementById('parentEmail').value;
    const name = document.getElementById('parentName').value;
    const phone2 = document.getElementById('phone2').value;
    const phone3 = document.getElementById('phone3').value;
    const address = document.getElementById('parentAddress').value;

    if (!email || !name || !phone2 || !phone3 || !address) {
      alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return false;
    }

    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ìƒíƒœ ê²€ì¦
    const emailHelp = document.getElementById('emailHelp');
    if (emailHelp.className.includes('text-danger')) {
      alert('ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ì¤‘ë³µëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
      return false;
    }

    // íœ´ëŒ€í° ë²ˆí˜¸ ì¡°í•©
    const phone1 = document.getElementById('phone1').value;
    document.getElementById('parentPhone').value = `${phone1}-${phone2}-${phone3}`;

    // ë¹„ìƒì—°ë½ì²˜ ì¡°í•© (ì„ íƒì‚¬í•­)
    const emergency1 = document.getElementById('emergency1').value;
    const emergency2 = document.getElementById('emergency2').value;
    const emergency3 = document.getElementById('emergency3').value;
    if (emergency2 && emergency3) {
      document.getElementById('childrenEmergencyPhone').value =
              `${emergency1}-${emergency2}-${emergency3}`;
    }

    // ë¡œë”© í‘œì‹œ
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì²˜ë¦¬ì¤‘...';

    // í¼ ì œì¶œ
    this.submit();
  });

  // ìë™ í¬ì»¤ìŠ¤ ì´ë™
  function setupAutoFocus(input, nextId) {
    input.addEventListener('input', function() {
      if (this.value.length >= this.maxLength) {
        const next = document.getElementById(nextId);
        if (next) next.focus();
      }
    });
  }

  // íœ´ëŒ€í° ë²ˆí˜¸ ìë™ í¬ì»¤ìŠ¤
  setupAutoFocus(document.getElementById('phone2'), 'phone3');

  // ë¹„ìƒì—°ë½ì²˜ ìë™ í¬ì»¤ìŠ¤
  setupAutoFocus(document.getElementById('emergency2'), 'emergency3');

  // ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ì²˜ë¦¬
  function setupNumberOnly(inputId) {
    const input = document.getElementById(inputId);
    if (input) {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    }
  }

  // ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ì„¤ì •
  setupNumberOnly('phone2');
  setupNumberOnly('phone3');
  setupNumberOnly('emergency2');
  setupNumberOnly('emergency3');

  // ì´ë©”ì¼ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
  document.getElementById('parentEmail').addEventListener('input', function() {
    const emailHelp = document.getElementById('emailHelp');
    emailHelp.textContent = 'ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    emailHelp.className = 'form-text';
    this.classList.remove('is-valid', 'is-invalid');
  });
</script>
</body>
</html>