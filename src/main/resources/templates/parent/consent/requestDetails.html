<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>학부모 등록 요청 상세 정보</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .detail-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
    }
    .section-title {
      color: #0d6efd;
      border-bottom: 2px solid #0d6efd;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .info-group {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-item {
      margin-bottom: 15px;
    }
    .info-label {
      font-weight: bold;
      color: #495057;
      min-width: 150px;
    }
    .consent-status {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
    }
    .status-agreed {
      background-color: #198754;
      color: white;
    }
    .status-pending {
      background-color: #ffc107;
      color: black;
    }
    .btn-group {
      margin-top: 30px;
    }
    .reject-reason {
      margin-top: 20px;
      display: none;
    }
    .current-status {
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
    }
    .process-info {
      margin-top: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .status-approved {
      background-color: #198754;
      color: white;
    }
    .status-rejected {
      background-color: #dc3545;
      color: white;
    }
    .status-pending {
      background-color: #ffc107;
      color: black;
    }
  </style>
</head>
<body>
<div class="detail-container">
  <h2 class="section-title">학부모 등록 요청 상세 정보</h2>

  <!-- 기본 정보 섹션 -->
  <div class="info-group">
    <h4 class="mb-4">기본 정보</h4>
    <div class="row info-item">
      <div class="col-md-3 info-label">이름</div>
      <div class="col-md-9" th:text="${detail.name}">홍**</div>
    </div>
    <div class="row info-item">
      <div class="col-md-3 info-label">이메일</div>
      <div class="col-md-9" th:text="${detail.email}">ab***@example.com</div>
    </div>
    <div class="row info-item">
      <div class="col-md-3 info-label">연락처</div>
      <div class="col-md-9" th:text="${detail.phone}">010-****-5678</div>
    </div>
    <div class="row info-item">
      <div class="col-md-3 info-label">비상연락처</div>
      <div class="col-md-9" th:text="${detail.childrenEmergencyPhone ?: '-'}">010-****-5678</div>
    </div>
    <div class="row info-item">
      <div class="col-md-3 info-label">주소</div>
      <div class="col-md-9">
        <div th:text="${detail.address}">서울시 강남구 ***</div>
        <div th:if="${detail.detailAddress}" th:text="${detail.detailAddress}" class="text-muted">***</div>
      </div>
    </div>
  </div>

  <!-- 동의 정보 섹션 -->
  <div class="info-group" th:if="${parent != null and parent.parentConsent != null}">
    <h4 class="mb-4">동의 정보</h4>
    <div class="row info-item">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>서비스 이용 약관</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.termsConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.termsConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>사진/영상 활용</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.photoConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.photoConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
    </div>
    <div class="row info-item">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>의료정보 활용</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.medicalInfoConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.medicalInfoConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>개인정보 수집/이용</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.privateConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.privateConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
    </div>
    <div class="row info-item">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span>커뮤니티 활동</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.communityConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.communityConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <span>비상연락망</span>
          <span th:class="'consent-status ' + ${parent.parentConsent.emergencyInfoConsent ? 'status-agreed' : 'status-pending'}"
                th:text="${parent.parentConsent.emergencyInfoConsent ? '동의' : '미동의'}">동의</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 승인/반려 버튼 -->
  <div class="info-group">
    <div class="current-status mb-3">
      <span class="info-label">현재 상태:</span>
      <span th:class="'status-badge ' + 'status-' + ${parent.registrationStatus.name().toLowerCase()}"
            th:text="${parent.registrationStatus.description}">대기중</span>
    </div>
    <!-- 승인/반려 정보 표시 -->
    <div th:if="${approvedAt != null}" class="process-info">
      <div class="info-item">
        <span class="info-label">처리 일시:</span>
        <span th:text="${#temporals.format(approvedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</span>
      </div>
      <div class="info-item">
        <span class="info-label">처리자:</span>
        <span th:text="${approvedBy ?: '-'}">관리자</span>
      </div>
      <div class="info-item" th:if="${rejectReason != null}">
        <span class="info-label">반려 사유:</span>
        <span th:text="${rejectReason}">반려 사유</span>
      </div>
    </div>
  </div>

  <div class="btn-group d-flex justify-content-center gap-3"
       th:if="${parent != null and parent.registrationStatus != null and parent.registrationStatus.name() == 'PENDING'}">
    <button type="button" class="btn btn-success" th:onclick="'approveRequest(' + ${parent.parentId} + ')'">승인</button>
    <button type="button" class="btn btn-danger" th:onclick="'showRejectForm(' + ${parent.parentId} + ')'">반려</button>
    <button type="button" class="btn btn-secondary" onclick="history.back()">뒤로가기</button>
  </div>

  <div class="btn-group d-flex justify-content-center gap-3"
       th:unless="${parent != null and parent.registrationStatus != null and parent.registrationStatus.name() == 'PENDING'}">
    <button type="button" class="btn btn-secondary" onclick="history.back()">뒤로가기</button>
  </div>

  <!-- 반려 사유 입력 폼 -->
  <div id="rejectForm" class="reject-reason">
    <div class="form-group">
      <label for="rejectReason" class="form-label">반려 사유</label>
      <textarea class="form-control" id="rejectReason" rows="3" placeholder="반려 사유를 입력해주세요."></textarea>
    </div>
    <div class="d-flex justify-content-end mt-3">
      <button type="button" class="btn btn-primary me-2" onclick="submitReject()">확인</button>
      <button type="button" class="btn btn-secondary" onclick="hideRejectForm()">취소</button>
    </div>
  </div>
</div>

  <script th:inline="javascript">
    // Thymeleaf 인라인 방식으로 parentId 한 번만 선언
    const parentId = /*[[${parent?.parentId}]]*/ null;
    function approveRequest(parentId) {
      if (!confirm('이 요청을 승인하시겠습니까?')) return;

      fetch(`/consent/admin/approve/${parentId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
              .then(response => response.json())
              .then(data => {
                alert(data.message);
                window.location.reload();
              })
              .catch(error => {
                console.error('Error:', error);
                alert('승인 처리 중 오류가 발생했습니다.');
              });
    }

    function showRejectForm(parentId) {
      // parentId를 전역 변수로 저장
      window.selectedRequestId = parentId;
      document.getElementById('rejectForm').style.display = 'block';
    }

  function hideRejectForm() {
    document.getElementById('rejectForm').style.display = 'none';
    document.getElementById('rejectReason').value = '';
  }

  function submitReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
      alert('반려 사유를 입력해주세요.');
      return;
    }

    fetch(`/consent/admin/reject/${parentId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason: reason })
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('반려 처리가 완료되었습니다.');
                window.location.href = '/consent/admin/requests';
              } else {
                throw new Error(data.message || '반려 처리 중 오류가 발생했습니다.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert(error.message);
            });
  }
</script>
</body>
</html>